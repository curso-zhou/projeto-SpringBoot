<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alexandria • Início</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/alexandria.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.14.5/dist/sweetalert2.min.css" />
  <style> body { font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; } .grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));} .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-1);padding:1rem;} .book-title{font-weight:700;margin:.25rem 0;} .book-author{color:var(--muted);} .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:1rem} .pill{background:rgba(0,0,0,.05);border:1px solid var(--border);padding:.45rem .7rem;border-radius:999px} .input-search{min-width:260px} .avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-2),var(--accent));box-shadow:var(--shadow-2);} .menu{display:flex;gap:.5rem;align-items:center} .muted{color:var(--muted);} .section{margin:1rem 0 1.25rem} .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;border:1px solid #0002;background:#fff8;box-shadow:var(--shadow-2);cursor:pointer} .icon-btn:hover{background:#fff} dialog.modal{border:none;padding:0;background:transparent} dialog.modal::backdrop{background:rgba(0,0,0,.35)} .modal-panel{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);max-width:640px;width:min(100%,640px);overflow:hidden} .modal-header{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(139,94,60,.12),rgba(139,94,60,.05))} .modal-body{padding:1.25rem} .modal-footer{padding:1rem 1.25rem;border-top:1px solid var(--border);display:flex;gap:.5rem;justify-content:flex-end;background:#ffffffc2}
  </style>
</head>
<body>
  <header class="header">
    <img src="/img/Alexandre.png" alt="Alexandria" class="logo-img" />
    <div class="brand">Alexandria</div>
  </header>
  <main class="auth-wrapper">
    <div class="toolbar">
      <div class="menu">
        <a class="btn" href="/home.html">Início</a>
        <a class="btn" href="/index.html">Demo</a>
      </div>
      <div class="menu">
        <span id="userEmail" class="pill muted">Carregando...</span>
        <button class="pill" id="btnToggleAlerts" title="Alternar alertas">Switch Alert</button>
        <button class="icon-btn" id="btnOpenProfile" title="Editar conta" aria-label="Editar conta">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5Zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5Z" fill="currentColor"/>
          </svg>
        </button>
        <button class="btn" id="btnLogout">Sair</button>
      </div>
    </div>

    <section class="section">
      <div class="row two">
        <div>
          <label for="q">Pesquisar livros</label>
          <input id="q" class="input input-search" placeholder="Título, autor ou ISBN" />
        </div>
        <div>
          <label for="categoria">Categoria</label>
          <select id="categoria" class="input">
            <option value="">Todas</option>
          </select>
        </div>
      </div>
    </section>

    <section>
      <h2 style="margin:0 0 .5rem">Livros em destaque</h2>
      <div id="books" class="grid"></div>
      <div id="booksEmpty" class="helper" style="display:none">Nenhum livro encontrado.</div>
    </section>

    <section class="section">
      <h2 style="margin:0 0 .5rem">Minha Coleção</h2>
      <form id="formAddIsbnHome" class="row two" style="align-items:flex-end">
        <div>
          <label for="isbnHome">Adicionar por ISBN</label>
          <input id="isbnHome" name="isbn" class="input" placeholder="978..." maxlength="20" />
        </div>
        <div>
          <button type="submit" class="btn">Adicionar à minha coleção</button>
        </div>
      </form>
      <div id="colecaoEmpty" class="helper" style="display:none">Sua coleção está vazia.</div>
      <div id="colecaoList" class="grid"></div>
    </section>

    <!-- Pop-up de Perfil agora renderizado via SweetAlert2 -->

    <div class="site-footer">© Alexandria • Construído com Spring Boot</div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.14.5/dist/sweetalert2.all.min.js"></script>
  <script src="/js/ui.js?v=20251009"></script>
  <script>
    // Utils
    function authHeaders(extra={}) {
      const t = localStorage.getItem('auth.token');
      return { ...(t ? { 'Authorization': 'Bearer ' + t } : {}), ...extra };
    }
    async function getJson(url) {
      const resp = await fetch(url, { headers: authHeaders() });
      let body; try { body = await resp.json(); } catch { body = await resp.text(); }
      return { status: resp.status, body };
    }
    async function postJson(url, data, method='POST') {
      const resp = await fetch(url, { method, headers: authHeaders({ 'Content-Type': 'application/json' }), body: JSON.stringify(data) });
      let body; try { body = await resp.json(); } catch { body = await resp.text(); }
      return { status: resp.status, body };
    }

    // Auth guard: require token
    (function guard(){
      const t = localStorage.getItem('auth.token');
      if (!t) { globalThis.location.href = '/login.html'; }
    })();

    // Predefined books fallback (if API not available or empty)
    const predefined = [
      { id: 1, titulo: 'A Biblioteca Invisível', autor: 'Genevieve Cogman', preco: 49.90, isbn: '978857686' },
      { id: 2, titulo: 'O Nome do Vento', autor: 'Patrick Rothfuss', preco: 59.90, isbn: '9788599296' },
      { id: 3, titulo: 'O Conto da Aia', autor: 'Margaret Atwood', preco: 44.90, isbn: '978853592' },
      { id: 4, titulo: 'Cem Anos de Solidão', autor: 'Gabriel García Márquez', preco: 39.90, isbn: '978853591' },
    ];

    let __isAdmin = false;
    let __isVendedor = false;
    async function loadUser() {
      const el = document.getElementById('userEmail');
      const r = await getJson('/api/auth/me');
      if (r.status === 200 && r.body) {
        el.textContent = r.body.email || '(sem email)';
        try { 
          __isAdmin = Array.isArray(r.body.roles) && r.body.roles.includes('ROLE_ADMIN'); 
          __isVendedor = Array.isArray(r.body.roles) && r.body.roles.includes('ROLE_VENDEDOR');
        } catch {}
        // Se for vendedor, cria botão visível para adicionar livros
        try {
          if (__isVendedor) {
            const menu = document.querySelector('.toolbar .menu');
            if (menu && !document.getElementById('btnOpenAddLivro')) {
              const btn = document.createElement('button');
              btn.className = 'btn';
              btn.id = 'btnOpenAddLivro';
              btn.textContent = 'Adicionar Livro';
              btn.addEventListener('click', openAddLivroModal);
              // inserir antes do botão de logout (último botão)
              const logout = document.getElementById('btnLogout');
              if (logout) menu.insertBefore(btn, logout);
              else menu.appendChild(btn);
            }
          }
        } catch(e) { /* não crítico */ }
        if (globalThis.ui) ui.success('Bem-vindo(a), ' + (r.body.nome || r.body.email));
      } else {
        el.textContent = 'Não autenticado';
      }
    }

    async function openAddLivroModal() {
      // Carrega categorias para o select
      let cats = [];
      try { const cr = await getJson('/api/categorias'); if (cr.status === 200 && Array.isArray(cr.body)) cats = cr.body; } catch {}
      const opts = cats.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
      if (!globalThis.Swal) { if (globalThis.ui) ui.info('Para adicionar livros abra a página de administração.'); return; }
      const res = await Swal.fire({
        title: 'Adicionar Livro',
        html: `
          <div class="row two" style="text-align:left">
            <div>
              <label for="swal-livro-titulo">Título</label>
              <input id="swal-livro-titulo" class="input" />
            </div>
            <div>
              <label for="swal-livro-autor">Autor</label>
              <input id="swal-livro-autor" class="input" />
            </div>
          </div>
          <div style="margin-top:.75rem;text-align:left">
            <label for="swal-livro-categoria">Categoria</label>
            <select id="swal-livro-categoria" class="input">${opts}</select>
          </div>
          <div class="row two" style="margin-top:.75rem;text-align:left">
            <div>
              <label for="swal-livro-preco">Preço</label>
              <input id="swal-livro-preco" class="input" type="number" step="0.01" />
            </div>
            <div>
              <label for="swal-livro-isbn">ISBN</label>
              <input id="swal-livro-isbn" class="input" />
            </div>
          </div>
          <div style="margin-top:.75rem;text-align:left">
            <label for="swal-livro-capa">URL imagem de capa (opcional)</label>
            <input id="swal-livro-capa" class="input" />
          </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Criar',
        cancelButtonText: 'Cancelar',
        preConfirm: () => ({
          titulo: document.getElementById('swal-livro-titulo').value.trim(),
          autor: document.getElementById('swal-livro-autor').value.trim(),
          categoriaId: document.getElementById('swal-livro-categoria').value,
          preco: document.getElementById('swal-livro-preco').value,
          isbn: document.getElementById('swal-livro-isbn').value.trim(),
          imagemCapaUrl: document.getElementById('swal-livro-capa').value.trim()
        })
      });
      if (res.isConfirmed) {
        const payload = res.value || {};
        // normaliza valores
        if (!payload.titulo || !payload.autor || !payload.categoriaId || !payload.preco) {
          if (globalThis.ui) ui.warn('Preencha título, autor, categoria e preço');
          return;
        }
        try {
          const body = { titulo: payload.titulo, autor: payload.autor, categoriaId: Number(payload.categoriaId), preco: Number(payload.preco), isbn: payload.isbn || null, imagemCapaUrl: payload.imagemCapaUrl || null };
          const r = await postJson('/api/livros', body);
          if (r.status === 201) {
            if (globalThis.ui) ui.success('Livro criado com sucesso');
            await loadBooks();
          } else {
            const msg = r.body && r.body.erro ? r.body.erro : 'Falha ao criar livro';
            if (globalThis.ui) ui.error(msg);
          }
        } catch (e) { if (globalThis.ui) ui.error('Erro ao criar livro'); }
      }
    }

    function renderBooks(items) {
      const container = document.getElementById('books');
      const empty = document.getElementById('booksEmpty');
      container.innerHTML = '';
      if (!items || items.length === 0) { empty.style.display = 'block'; return; }
      empty.style.display = 'none';
      for (const b of items) {
        const card = document.createElement('div');
        card.className = 'card';
        if (b.isbn) { card.dataset.isbn = b.isbn; card.style.cursor = 'pointer'; }
        const img = b.imagemCapaUrl ? `<img src="${b.imagemCapaUrl}" alt="Capa" style="width:100%;max-height:220px;object-fit:contain;border-radius:8px;margin-bottom:.5rem" onerror="this.style.display='none'" />` : '';
        const addBtn = b.isbn ? `<button class="btn" data-add-isbn="${b.isbn}">Adicionar à minha coleção</button>` : '';
        const adminBtn = __isAdmin ? `<button class="btn" data-admin-del="${b.id}">Remover (Admin)</button>` : '';
        card.innerHTML = `
          ${img}
          <div class="book-title">${b.titulo}</div>
          <div class="book-author">${b.autor}</div>
          <div class="muted small">ISBN: ${b.isbn || '-'}</div>
          <div class="muted small">Preço: R$ ${Number(b.preco).toFixed(2)}</div>
          <div style="margin-top:.5rem;display:flex;gap:.5rem;justify-content:flex-end">${addBtn}${adminBtn}</div>
        `;
        container.appendChild(card);
      }
      if (__isAdmin) {
        for (const btn of container.querySelectorAll('[data-admin-del]')) {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            const id = btn.dataset.adminDel;
            try {
              const resp = await fetch('/api/admin/livros/' + id, { method: 'DELETE', headers: authHeaders() });
              if (resp.status === 204) {
                if (globalThis.ui) ui.success('Livro removido');
                await loadBooks();
              } else if (resp.status === 409) {
                const body = await resp.json().catch(()=>({}));
                const msg = body && body.erro ? body.erro : 'Livro em uso e não pode ser removido.';
                if (globalThis.ui) ui.warn(msg);
              } else {
                if (globalThis.ui) { ui.warn('Falha ao remover livro'); }
              }
            } catch {
              if (globalThis.ui) ui.error('Erro ao remover livro');
            }
          });
        }
      }
      // Botão adicionar por ISBN
      for (const btn of container.querySelectorAll('[data-add-isbn]')) {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          const isbn = btn.dataset.addIsbn;
          if (!isbn) return;
          try {
            const r = await postJson('/api/colecao/add', { isbn });
            if (r.status === 200) {
              if (globalThis.ui) ui.success('Livro adicionado à coleção');
              await loadColecao();
            } else if (r.status === 400) {
              const msg = r.body && r.body.erro ? r.body.erro : 'Falha ao adicionar';
              if (globalThis.ui) ui.warn('Não foi possível adicionar', msg);
            } else if (r.status === 401) {
              if (globalThis.ui) ui.error('Não autorizado', 'Faça login e tente novamente');
            }
          } catch {
            if (globalThis.ui) ui.error('Erro inesperado ao adicionar');
          }
        });
      }
      // Clique no card para adicionar (se houver ISBN)
      for (const card of container.querySelectorAll('.card[data-isbn]')) {
        card.addEventListener('click', async () => {
          const isbn = card.dataset.isbn;
          if (!isbn) return;
          try {
            const r = await postJson('/api/colecao/add', { isbn });
            if (r.status === 200) {
              if (globalThis.ui) ui.success('Livro adicionado à coleção');
              await loadColecao();
            } else if (r.status === 400) {
              const msg = r.body && r.body.erro ? r.body.erro : 'Falha ao adicionar';
              if (globalThis.ui) ui.warn('Não foi possível adicionar', msg);
            } else if (r.status === 401) {
              if (globalThis.ui) ui.error('Não autorizado', 'Faça login e tente novamente');
            }
          } catch {
            if (globalThis.ui) ui.error('Erro inesperado ao adicionar');
          }
        });
      }
    }

    // Coleção
    function renderColecao(items) {
      const list = document.getElementById('colecaoList');
      const empty = document.getElementById('colecaoEmpty');
      list.innerHTML = '';
      if (!Array.isArray(items) || items.length === 0) { empty.style.display = 'block'; return; }
      empty.style.display = 'none';
      for (const it of items) {
        const card = document.createElement('div');
        card.className = 'card';
        const img = it.imagemCapaUrl ? `<img src="${it.imagemCapaUrl}" alt="Capa" style="width:100%;max-height:260px;object-fit:contain;border-radius:8px;margin-bottom:.5rem" onerror="this.style.display='none'" />` : '';
        const preco = (typeof it.preco === 'number') ? Number(it.preco) : (it.preco && it.preco.amount) ? Number(it.preco.amount) : it.preco;
        card.innerHTML = `
          ${img}
          <div class="book-title">${it.titulo || '-'}</div>
          <div class="book-author">${it.autor || ''}</div>
          <div class="muted small">ISBN: ${it.isbn || '-'}</div>
          <div class="muted small">Preço: ${preco ? ('R$ ' + Number(preco).toFixed(2)) : 'Fora de estoque'}</div>
          <div style="margin-top:.5rem;display:flex;gap:.5rem;justify-content:flex-end">
            <button class="btn btn-danger" data-del="${it.id}">Remover</button>
          </div>
        `;
        list.appendChild(card);
      }
      // Bind delete buttons
      list.querySelectorAll('[data-del]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const id = btn.getAttribute('data-del');
          try {
            const resp = await fetch('/api/colecao/' + id, { method: 'DELETE', headers: authHeaders() });
            if (resp.status === 200 || resp.status === 204) {
              if (window.ui) ui.success('Removido da coleção');
              await loadColecao();
            } else {
              if (window.ui) ui.warn('Não foi possível remover');
            }
          } catch { if (window.ui) ui.error('Erro ao remover'); }
        });
      });
    }

    async function loadColecao() {
      try {
        const r = await getJson('/api/colecao');
        if (r.status === 200) { renderColecao(r.body); }
        else { renderColecao([]); }
      } catch { renderColecao([]); }
    }

    async function loadCategories() {
      const sel = document.getElementById('categoria');
      try {
        const r = await getJson('/api/categorias');
        if (r.status === 200 && Array.isArray(r.body)) {
          for (const c of r.body) {
            const opt = document.createElement('option');
            opt.value = c.id; opt.textContent = c.nome; sel.appendChild(opt);
          }
        }
      } catch {}
    }

    async function loadBooks() {
      try {
        const r = await getJson('/api/livros');
        if (r.status === 200 && Array.isArray(r.body)) {
          globalThis.__books = r.body;
          renderBooks(globalThis.__books);
          return;
        }
      } catch {}
        globalThis.__books = predefined;
        renderBooks(globalThis.__books);
    }

    function applyFilters() {
      const q = document.getElementById('q').value.trim().toLowerCase();
      const cat = document.getElementById('categoria').value;
  let items = globalThis.__books || [];
      if (q) {
        items = items.filter(b => `${b.titulo} ${b.autor} ${b.isbn}`.toLowerCase().includes(q));
      }
      if (cat) {
        items = items.filter(b => String(b.categoriaId) === String(cat));
      }
      renderBooks(items);
    }

    document.getElementById('q').addEventListener('input', applyFilters);
    document.getElementById('categoria').addEventListener('change', applyFilters);

    document.getElementById('btnLogout').addEventListener('click', () => {
      localStorage.removeItem('auth.token');
  globalThis.location.href = '/login.html';
    });

    function esc(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    async function showProfilePopup(){
      let nome = '', email = '';
      try {
        const r = await getJson('/api/auth/me');
        if (r.status === 200 && r.body) { nome = r.body.nome || ''; email = r.body.email || ''; }
      } catch {}
  if (!globalThis.Swal) { if (globalThis.ui) { await ui.info('Abra o editor de conta pelo navegador.'); } return; }
      const result = await Swal.fire({
        title: 'Editar conta',
        html: `
          <div class="row two" style="text-align:left">
            <div>
              <label for="swal-profile-nome">Nome</label>
              <input id="swal-profile-nome" class="input" value="${esc(nome)}" />
            </div>
            <div>
              <label for="swal-profile-email">Email</label>
              <input id="swal-profile-email" class="input" type="email" value="${esc(email)}" />
            </div>
          </div>
          <div class="row two" style="margin-top:.75rem;text-align:left">
            <div>
              <label for="swal-profile-senha-atual">Senha atual</label>
              <input id="swal-profile-senha-atual" class="input" type="password" />
            </div>
            <div>
              <label for="swal-profile-nova-senha">Nova senha</label>
              <input id="swal-profile-nova-senha" class="input" type="password" />
            </div>
          </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Salvar',
        cancelButtonText: 'Cancelar',
        customClass: { popup: 'alex-swal-popup', title: 'alex-swal-title', actions: 'alex-swal-actions', confirmButton: 'alex-btn', cancelButton: 'alex-btn-secondary' },
        buttonsStyling: false,
        preConfirm: () => {
          return {
            nome: document.getElementById('swal-profile-nome').value.trim(),
            email: document.getElementById('swal-profile-email').value.trim(),
            senhaAtual: document.getElementById('swal-profile-senha-atual').value,
            novaSenha: document.getElementById('swal-profile-nova-senha').value
          };
        }
      });
      if (result.isConfirmed) {
        const payload = result.value || {};
        for (const k of Object.keys(payload)) {
          if (payload[k] === '') delete payload[k];
        }
        const resp = await fetch('/api/auth/profile', {
          method: 'PUT',
          headers: authHeaders({ 'Content-Type': 'application/json' }),
          body: JSON.stringify(payload)
        });
        if (resp.status === 200) {
          if (globalThis.ui) { ui.success('Perfil atualizado'); }
          await loadUser();
        } else {
          // Mostrar erro de atualização de perfil
          const msg = 'Falha ao atualizar perfil';
          if (globalThis.ui) { ui.error(msg); }
        }
      }
    }
    document.getElementById('btnOpenProfile').addEventListener('click', showProfilePopup);

    // Bootstrap
    loadUser();
    (async ()=>{ await loadCategories(); await loadBooks(); })();
    loadColecao();

    // Handler: adicionar por ISBN
    document.getElementById('formAddIsbnHome').addEventListener('submit', async (e) => {
      e.preventDefault();
      const input = document.getElementById('isbnHome');
      const isbn = String(input.value||'').trim();
      if (!isbn) { if (window.ui) ui.warn('Informe o ISBN'); return; }
      try {
        const r = await postJson('/api/colecao/add', { isbn });
        if (r.status === 200) {
          if (globalThis.ui) ui.success('Livro adicionado à coleção');
          input.value = '';
          await loadColecao();
        } else if (r.status === 400) {
          const msg = r.body && r.body.erro ? r.body.erro : 'Falha ao adicionar';
          if (globalThis.ui) ui.warn('Não foi possível adicionar', msg);
        } else if (r.status === 401) {
          if (globalThis.ui) ui.error('Não autorizado', 'Faça login e tente novamente');
        }
      } catch (err) {
        if (window.ui) ui.error('Erro inesperado', String(err));
      }
    });

    // Toggle global de alertas
    const btnToggle = document.getElementById('btnToggleAlerts');
    if (btnToggle) {
      btnToggle.addEventListener('click', ()=>{
        if (!globalThis.ui) return;
        const mode = ui.toggle();
        ui.info('Modo de alerta: ' + mode);
        btnToggle.textContent = 'Switch Alert ('+mode+')';
      });
      if (globalThis.ui) btnToggle.textContent = 'Switch Alert ('+ui.mode+')';
    }
  </script>
</body>
</html>
